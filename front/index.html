<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>æ±‡ç‡è½¬æ¢ä¸æ–‡ç« ç®¡ç†å¹³å°</title>
<style>
    body { font-family: 'Segoe UI', sans-serif; background:#f0f4f8; margin:0; padding:0; }
    header { background:#4CAF50; color:white; padding:15px 30px; display:flex; justify-content:space-between; align-items:center; box-shadow:0 2px 6px rgba(0,0,0,0.2);}
    header h1 { margin:0; font-size:22px; }
    nav { display:flex; gap:12px; }
    nav button { background:#fff; color:#4CAF50; border:none; padding:8px 16px; border-radius:6px; cursor:pointer; font-weight:bold; transition:0.2s; }
    nav button:hover { background:#e0e0e0; }
    .container { display:flex; justify-content:center; align-items:center; height:calc(100vh - 60px); }
    .card { background:white; padding:30px; border-radius:12px; box-shadow:0 6px 15px rgba(0,0,0,0.1); width:360px; text-align:center; display:none; }
    input, textarea, button { width:100%; padding:10px; margin:10px 0; border-radius:6px; border:1px solid #ccc; font-size:14px; }
    button { background:#4CAF50; color:white; border:none; cursor:pointer; }
    button:hover { background:#45a049; }
    .message { margin-top:10px; font-weight:bold; }
    .success { color:green; }
    .error { color:red; }
    .result { margin-top:15px; font-weight:bold; color:#222; text-align:left; }
</style>
</head>
<body>

<header>
    <h1>æ±‡ç‡ä¸æ–‡ç« ç®¡ç†å¹³å°</h1>
    <nav>
        <button onclick="showCard('loginCard')">ç™»å½•</button>
        <button onclick="showCard('registerCard')">æ³¨å†Œ</button>
        <button onclick="showCard('exchangeCard')">æ±‡ç‡è½¬æ¢</button>
        <button onclick="showArticleCard()">æ–‡ç« ç®¡ç†</button>
        <button onclick="logout()">é€€å‡º</button>
    </nav>
</header>

<div class="container">
    <!-- ç™»å½• -->
    <div id="loginCard" class="card">
        <h2>ç™»å½•</h2>
        <input id="loginUsername" placeholder="ç”¨æˆ·å">
        <input id="loginPassword" placeholder="å¯†ç " type="password">
        <button onclick="login()">ç™»å½•</button>
        <div id="loginResult" class="message"></div>
    </div>

    <!-- æ³¨å†Œ -->
    <div id="registerCard" class="card">
        <h2>æ³¨å†Œ</h2>
        <input id="regUsername" placeholder="ç”¨æˆ·å">
        <input id="regPassword" placeholder="å¯†ç " type="password">
        <button onclick="register()">æ³¨å†Œ</button>
        <div id="regResult" class="message"></div>
    </div>

    <!-- æ±‡ç‡è½¬æ¢ -->
    <div id="exchangeCard" class="card">
        <h2>æ±‡ç‡è½¬æ¢å·¥å…·</h2>
        <input id="fromCurrency" placeholder="æ¥æºè´§å¸ï¼Œä¾‹å¦‚ USD">
        <input id="toCurrency" placeholder="ç›®æ ‡è´§å¸ï¼Œä¾‹å¦‚ CNY">
        <input id="amount" placeholder="é‡‘é¢ï¼Œä¾‹å¦‚ 100" type="number">
        <button onclick="convert()">è½¬æ¢</button>
        <div id="result" class="result"></div>
    </div>

    <!-- æ–‡ç« ç®¡ç† -->
    <div id="articleCard" class="card">
        <h2>æ–‡ç« ç®¡ç†</h2>
        <input id="articleTitle" placeholder="æ ‡é¢˜">
        <textarea id="articleContent" placeholder="å†…å®¹" style="height:80px;"></textarea>
        <button onclick="createArticle()">å‘å¸ƒæ–‡ç« </button>
        <div id="articleResult" class="message"></div>

        <h3>æ–‡ç« åˆ—è¡¨</h3>
        <div id="articleList" class="result"></div>
    </div>
</div>

<script>
const API = "http://localhost:8080/api";
const USER = "http://localhost:8080/user";
const ARTICLE = "http://localhost:8080/article";

// æ˜¾ç¤ºæŒ‡å®šå¡ç‰‡
function showCard(cardId){
    const cards = ['loginCard','registerCard','exchangeCard','articleCard'];
    cards.forEach(id => { document.getElementById(id).style.display = (id===cardId)?'block':'none'; });
}

// æ˜¾ç¤ºä¿¡æ¯
function showMessage(id,msg,success){
    const el = document.getElementById(id);
    el.innerText = msg;
    el.className = 'message ' + (success?'success':'error');
}

// å°è£…å¸¦ Token çš„è¯·æ±‚
async function authFetch(url, options={}){
    const token = localStorage.getItem("token");
    options.headers = {...options.headers,"Authorization":"Bearer "+token};
    return fetch(url, options);
}

// æ³¨å†Œ
async function register(){
    const username = document.getElementById("regUsername").value.trim();
    const password = document.getElementById("regPassword").value;
    if(!username || !password){ showMessage("regResult","è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ",false); return; }

    const res = await fetch(`${USER}/register`,{
        method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({username,password})
    });
    const data = await res.json();
    if(res.status===201){ showMessage("regResult","æ³¨å†ŒæˆåŠŸï¼è¯·ç™»å½•",true); showCard('loginCard'); }
    else { showMessage("regResult",data.error||"æ³¨å†Œå¤±è´¥",false); }
}

// ç™»å½•
async function login(){
    const username = document.getElementById("loginUsername").value.trim();
    const password = document.getElementById("loginPassword").value;
    if(!username||!password){ showMessage("loginResult","è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ",false); return; }

    const res = await fetch(`${USER}/login`,{
        method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({username,password})
    });
    const data = await res.json();
    if(res.status===200){
        showMessage("loginResult","ç™»å½•æˆåŠŸï¼",true);
        localStorage.setItem("token",data.token);
        showCard("exchangeCard");
    }else{ showMessage("loginResult",data.error||"ç™»å½•å¤±è´¥",false); }
}

// é€€å‡º
function logout(){ localStorage.removeItem("token"); showCard('loginCard'); }

// æ±‡ç‡è½¬æ¢
async function convert(){
    const from = document.getElementById("fromCurrency").value.trim().toUpperCase();
    const to = document.getElementById("toCurrency").value.trim().toUpperCase();
    const amount = parseFloat(document.getElementById("amount").value);
    if(!from||!to||isNaN(amount)){ document.getElementById("result").innerText="è¯·è¾“å…¥å®Œæ•´ä¿¡æ¯"; return; }

    const res = await authFetch(`${API}/exchangeRates?from=${from}&to=${to}`);
    if(res.status===401){ alert("ç™»å½•çŠ¶æ€å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•"); logout(); return; }

    const data = await res.json();
    if(!data.rate){ document.getElementById("result").innerText="æœªæ‰¾åˆ°æ±‡ç‡ï¼Œè¯·å…ˆæ·»åŠ "; return; }

    document.getElementById("result").innerHTML =
        `ä½¿ç”¨æ±‡ç‡ï¼š${data.from_currency} â†’ ${data.to_currency} = ${data.rate}<br>
         ${amount} ${data.from_currency} â‰ˆ ${(amount*data.rate).toFixed(2)} ${data.to_currency}`;
}

// æ˜¾ç¤ºæ–‡ç« ç®¡ç†
function showArticleCard(){ showCard("articleCard"); getArticles(); }

// åˆ›å»ºæ–‡ç« 
async function createArticle(){
    const title=document.getElementById("articleTitle").value.trim();
    const content=document.getElementById("articleContent").value.trim();
    if(!title||!content){ showMessage("articleResult","è¯·è¾“å…¥æ ‡é¢˜å’Œå†…å®¹",false); return; }

    const res = await authFetch(`${ARTICLE}/create`,{
        method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({title,content})
    });
    const data = await res.json();
    if(res.status===201){
        showMessage("articleResult","å‘å¸ƒæˆåŠŸ",true);
        document.getElementById("articleTitle").value="";
        document.getElementById("articleContent").value="";
        getArticles();
    }else{ showMessage("articleResult",data.error||"å‘å¸ƒå¤±è´¥",false); }
}

async function getArticles(){
    const res = await authFetch(`${ARTICLE}/get`);
    const data = await res.json();
    const listEl = document.getElementById("articleList");
    listEl.innerHTML = "";

    if (!data.articles || !data.articles.length) {
        listEl.innerText = "æš‚æ— æ–‡ç« ";
        return;
    }

    for (const a of data.articles) {
        // æ”¯æŒåç«¯è¿”å› ID æˆ– id ä¸¤ç§å†™æ³•
        const articleId = (a.id !== undefined) ? a.id : a.ID;
        console.log("æ–‡ç« ID:", articleId, "title:", a.title);

        const div = document.createElement("div");
        div.style.border = "1px solid #ccc";
        div.style.padding = "8px";
        div.style.margin = "5px 0";

        // å®‰å…¨æ¸²æŸ“ï¼štitle/content ç”¨ textContent é˜² XSSï¼ˆç”¨ innerHTML ä»…åœ¨ä½ ä¿¡ä»»å†…å®¹æ—¶ï¼‰
        const titleEl = document.createElement("div");
        titleEl.innerHTML = `<b>${escapeHtml(a.title)}</b> (ä½œè€…ID: ${a.user_id})`;

        const contentEl = document.createElement("div");
        contentEl.textContent = a.content;

        // ç‚¹èµè®¡æ•°å ä½
        const likeCountSpan = document.createElement("span");
        likeCountSpan.id = `like-count-${articleId}`;
        likeCountSpan.textContent = "åŠ è½½ä¸­...";

        // ç‚¹èµæŒ‰é’®
        const likeBtn = document.createElement("button");
        likeBtn.innerText = "ç‚¹èµ";
        likeBtn.style.marginTop = "6px";
        likeBtn.onclick = () => likeArticle(articleId, likeBtn);

        // åˆ é™¤æŒ‰é’®ï¼ˆæ˜¾ç¤ºæ‰€æœ‰ï¼Œåç«¯ä¼šåˆ¤æ–­æƒé™ï¼›ä½ å¯ä»¥åœ¨æ­¤å¤„éšè—éä½œè€…ï¼‰
        const delBtn = document.createElement("button");
        delBtn.innerText = "åˆ é™¤";
        delBtn.style.marginLeft = "8px";
        delBtn.onclick = () => deleteArticle(articleId);

        // ç»„è£…
        div.appendChild(titleEl);
        div.appendChild(contentEl);
        const meta = document.createElement("div");
        meta.style.marginTop = "8px";
        meta.appendChild(document.createTextNode("ğŸ‘ "));
        meta.appendChild(likeCountSpan);
        meta.appendChild(document.createTextNode(" äººç‚¹èµ"));
        meta.appendChild(document.createElement("br"));
        meta.appendChild(likeBtn);
        meta.appendChild(delBtn);

        div.appendChild(meta);
        listEl.appendChild(div);

        // åŠ è½½ç‚¹èµæ•°å¹¶æ›´æ–°æŒ‰é’®æ–‡æœ¬
        updateLikeCount(articleId, likeBtn);
    }
}

const SERVER = "http://localhost:8080";

// ç‚¹èµ / å–æ¶ˆ
async function likeArticle(articleId, btn){
    const res = await authFetch(`${SERVER}/like/toggle/${articleId}`, {
        method: "POST"
    });
    const data = await res.json();
    updateLikeCount(articleId, btn);
}

// è·å–ç‚¹èµæ•°é‡
async function updateLikeCount(articleId, btn){
    const res = await authFetch(`${SERVER}/like/get/${articleId}`);
    const data = await res.json();
    const count = data.like_count || 0;

    const countSpan = document.getElementById(`like-count-${articleId}`);
    if(countSpan) countSpan.textContent = count;

    if(btn) btn.innerText = `ğŸ‘ ç‚¹èµ(${count})`;
}

// åˆ é™¤æ–‡ç« ï¼ˆåç«¯ä¼šæ ¡éªŒ userIDï¼‰
async function deleteArticle(id){
    if(!id) return alert("æ–‡ç« IDæ— æ•ˆ");
    if(!confirm("ç¡®å®šåˆ é™¤è¯¥æ–‡ç« å—ï¼Ÿ")) return;

    const res = await authFetch(`${ARTICLE}/delete/${encodeURIComponent(id)}`, { method: "DELETE" });
    const data = await res.json();
    if (res.status === 200) {
        alert("åˆ é™¤æˆåŠŸ");
        getArticles();
    } else {
        alert(data.error || data.message || "åˆ é™¤å¤±è´¥");
    }
}

// ç®€å•çš„æ–‡æœ¬è½¬ä¹‰ï¼ˆé˜² XSSï¼‰
function escapeHtml(str){
    if(!str) return "";
    return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
}
</script>
</body>
</html>
